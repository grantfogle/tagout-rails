<div class="dashboard">
    <h1>Draw Results by Hunt Code</h1>

    <%= form_with url: dashboard_path, class: 'form form__inline', method: :get, scope: :filters, local: true do |f| %>
        <div class="form__field">
            <%= f.label :species, "Species" %>
            <%= f.select :species,
                options_for_select(HuntStat::SPECIES_OPTIONS, @filters[:species]),
                { include_blank: "All Species" } %>
        </div>

        <div class="form__field">
            <%= f.label :sex, "Sex" %>
            <%= f.select :sex,
                options_for_select(HuntStat.sex_options_for_select, @filters[:sex]),
                { include_blank: "All" } %>
        </div>

        <div class="form__field">
            <%= f.label :hunt_method, "Method" %>
            <%= f.select :hunt_method,
                options_for_select(HuntStat::METHOD_OPTIONS, @filters[:hunt_method]),
                { include_blank: "All Methods" } %>
        </div>

        <div class="form__field">
            <%= f.label :resident, "Status" %>
            <%= f.select :resident,
                options_for_select(HuntStat::RESIDENT_OPTIONS, @filters[:resident]&.to_s),
                { include_blank: "All" } %>
        </div>

        <div class="form__actions">
            <%= f.submit "Filter" %>
            <%= link_to "Clear", dashboard_path %>
        </div>
    <% end %>

    <% if @draw_results.any? %>
        <section class="draw-results">
            <% @draw_results.each do |hunt_code, data| %>
                <div class="hunt-card">
                    <div class="hunt-card__header">
                        <h2 class="hunt-card__title"><%= hunt_code %></h2>
                    </div>
                    
                    <div class="results-table-container">
                        <table class="results-table draw-table">
                            <thead>
                                <tr>
                                    <th class="sticky-col">Status</th>
                                    <% (data[:max_points]).downto(0).each do |pts| %>
                                        <th class="point-header"><%= pts %> pts</th>
                                    <% end %>
                                    <th class="choice-header">2nd</th>
                                    <th class="choice-header">3rd</th>
                                    <th class="choice-header">4th</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%# Resident Row - show if no filter or resident filter %>
                                <% if @filters[:resident].nil? || @filters[:resident] == true %>
                                    <tr class="resident-row">
                                        <td class="sticky-col status-cell">
                                            <span class="status-badge status-badge--resident">R</span>
                                        </td>
                                        <% (data[:max_points]).downto(0).each do |pts| %>
                                            <% cell = data[:resident][:pref][pts] %>
                                            <td class="draw-cell <%= cell_class(cell) %>">
                                                <% if cell %>
                                                    <div class="draw-cell__odds"><%= display_odds(cell) %></div>
                                                    <div class="draw-cell__ratio"><%= cell[:success] %>/<%= cell[:applicants] %></div>
                                                <% else %>
                                                    <span class="draw-cell__empty">—</span>
                                                <% end %>
                                            </td>
                                        <% end %>
                                        <% [2, 3, 4].each do |choice| %>
                                            <% cell = data[:resident][:choice][choice] %>
                                            <td class="draw-cell choice-cell <%= cell_class(cell) %>">
                                                <% if cell %>
                                                    <div class="draw-cell__odds"><%= display_odds(cell) %></div>
                                                    <div class="draw-cell__ratio"><%= cell[:success] %>/<%= cell[:applicants] %></div>
                                                <% else %>
                                                    <span class="draw-cell__empty">—</span>
                                                <% end %>
                                            </td>
                                        <% end %>
                                    </tr>
                                <% end %>
                                
                                <%# Non-Resident Row - show if no filter or non-resident filter %>
                                <% if @filters[:resident].nil? || @filters[:resident] == false %>
                                    <tr class="nonresident-row">
                                        <td class="sticky-col status-cell">
                                            <span class="status-badge status-badge--nonresident">NR</span>
                                        </td>
                                        <% (data[:max_points]).downto(0).each do |pts| %>
                                            <% cell = data[:nonresident][:pref][pts] %>
                                            <td class="draw-cell <%= cell_class(cell) %>">
                                                <% if cell %>
                                                    <div class="draw-cell__odds"><%= display_odds(cell) %></div>
                                                    <div class="draw-cell__ratio"><%= cell[:success] %>/<%= cell[:applicants] %></div>
                                                <% else %>
                                                    <span class="draw-cell__empty">—</span>
                                                <% end %>
                                            </td>
                                        <% end %>
                                        <% [2, 3, 4].each do |choice| %>
                                            <% cell = data[:nonresident][:choice][choice] %>
                                            <td class="draw-cell choice-cell <%= cell_class(cell) %>">
                                                <% if cell %>
                                                    <div class="draw-cell__odds"><%= display_odds(cell) %></div>
                                                    <div class="draw-cell__ratio"><%= cell[:success] %>/<%= cell[:applicants] %></div>
                                                <% else %>
                                                    <span class="draw-cell__empty">—</span>
                                                <% end %>
                                            </td>
                                        <% end %>
                                    </tr>
                                <% end %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% end %>
        </section>
    <% else %>
        <section class="empty-state">
            <p>No draw results found. Try adjusting your filters.</p>
        </section>
    <% end %>
</div>
